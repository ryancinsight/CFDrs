name: Performance Benchmarking

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly performance benchmarks
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
  workflow_dispatch:
    inputs:
      benchmark_type:
        description: 'Type of benchmark to run'
        required: false
        default: 'comprehensive'
        type: choice
        options:
        - comprehensive
        - regression
        - production
      problem_sizes:
        description: 'Problem sizes to benchmark (comma-separated)'
        required: false
        default: '32,64,128,256'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  benchmark:
    name: Performance Benchmarking
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for regression detection

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Install benchmark dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y valgrind linux-tools-common

    - name: Build benchmarks
      run: cargo build --release --bench comprehensive_cfd_benchmarks

    - name: Run comprehensive benchmarks
      if: github.event.inputs.benchmark_type == 'comprehensive' || github.event_name != 'workflow_dispatch'
      run: |
        cargo bench --bench comprehensive_cfd_benchmarks -- --verbose | tee benchmark_results.txt

    - name: Run regression detection benchmarks
      if: github.event.inputs.benchmark_type == 'regression' || github.event_name == 'schedule'
      run: |
        cargo bench --bench regression_detection -- --verbose | tee regression_results.txt

    - name: Run production validation benchmarks
      if: github.event.inputs.benchmark_type == 'production'
      run: |
        cargo bench --bench production_validation -- --verbose | tee production_results.txt

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-${{ matrix.os }}
        path: |
          benchmark_results.txt
          regression_results.txt
          production_results.txt

    - name: Slack notification (on failure)
      if: failure() && env.SLACK_WEBHOOK_URL
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        fields: repo,message,commit,author,action,eventName,ref,workflow
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  performance-alerting:
    name: Performance Alerting
    runs-on: ubuntu-latest
    needs: benchmark
    if: always() && needs.benchmark.result == 'failure'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Send email alerts
      if: env.SMTP_SERVER && env.SMTP_USERNAME
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT || 587 }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: |
          ðŸš¨ CFD Suite Performance Alert - ${{ github.repository }}
        to: ${{ secrets.PERFORMANCE_ALERT_EMAILS }}
        from: GitHub Actions <noreply@github.com>
        body: |
          Performance Alert for CFD Suite

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
          Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          A performance issue has been detected. Please review the benchmark results and investigate.

          ---
          This is an automated message from GitHub Actions.
